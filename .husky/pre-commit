#!/bin/sh
set -e

echo "ğŸš€ Running pre-commit checks..."

# 1. Run linting and type checking
echo "ğŸ“ Running linting..."
npm run lint

echo "ğŸ” Running type checking..."
npm run check

# 2. Run tests to ensure they pass
echo "ğŸ§ª Running tests..."
npm test

# 3. Security audit
echo "ğŸ”’ Running security audit..."
npm audit --audit-level=high || {
  echo "âš ï¸  High severity security vulnerabilities found!"
  echo "Run 'npm audit' for details or 'npm audit fix' to fix automatically"
  exit 1
}

# Show any moderate/low vulnerabilities as warnings
echo "â„¹ï¸  Checking for lower severity vulnerabilities..."
npm audit --audit-level=moderate || echo "âš ï¸  Some moderate/low severity vulnerabilities found (non-blocking)"

# 4. Check for outdated dependencies (warning only)
echo "ğŸ“¦ Checking for outdated dependencies..."
npm outdated || echo "â„¹ï¸  Some dependencies may be outdated (non-blocking)"

# 5. Validate Docker files if they exist
if [ -f "Dockerfile" ]; then
  echo "ğŸ³ Validating Dockerfiles..."
  if command -v hadolint >/dev/null 2>&1; then
    hadolint Dockerfile || echo "âš ï¸  Dockerfile linting issues found (non-blocking)"
    hadolint Dockerfile.frontend || echo "âš ï¸  Dockerfile.frontend linting issues found (non-blocking)"
    hadolint Dockerfile.server || echo "âš ï¸  Dockerfile.server linting issues found (non-blocking)"
  else
    echo "â„¹ï¸  hadolint not installed - skipping Dockerfile validation"
  fi
  
  # Only test Docker build if Docker daemon is running
  if command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
    echo "ğŸ§ª Testing Docker build (build stage only)..."
    docker build -f Dockerfile.frontend --target build -t test-frontend-build . || {
      echo "âŒ Frontend Docker build failed!"
      exit 1
    }
    docker build -f Dockerfile.server --target build -t test-server-build . || {
      echo "âŒ Server Docker build failed!"
      exit 1
    }
    echo "âœ… Docker builds successful"
  else
    echo "â„¹ï¸  Docker not available or daemon not running - skipping Docker build tests"
  fi
fi

# 6. Validate docker-compose files
if [ -f "docker-compose.yml" ] && command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
  echo "ğŸ”§ Validating Docker Compose files..."
  docker compose config -q || {
    echo "âŒ docker-compose.yml validation failed!"
    exit 1
  }
  docker compose -f docker-compose.dev.yml config -q || {
    echo "âŒ docker-compose.dev.yml validation failed!"
    exit 1
  }
  echo "âœ… Docker Compose files valid"
elif [ -f "docker-compose.yml" ]; then
  echo "â„¹ï¸  Docker not available - skipping Docker Compose validation"
fi

echo "âœ… All pre-commit checks passed!"