#!/bin/sh
set -e

echo "🚀 Running pre-push checks..."

# 1. Run build to ensure everything compiles
echo "🏗️  Running full build..."
npm run build

# 2. Run comprehensive tests with coverage
echo "🧪 Running tests with coverage..."
npm run test:coverage

# 3. Run Docker integration tests (if Docker is available)
if command -v docker >/dev/null 2>&1; then
  echo "🐳 Running Docker integration tests..."
  
  # Test Docker Compose setup
  if [ -f "docker-compose.yml" ]; then
    echo "🧪 Testing Docker Compose (quick test)..."
    
    # Build images
    docker compose build
    
    # Start services
    docker compose up -d
    
    # Wait for services to be ready
    echo "⏳ Waiting for services to start..."
    sleep 15
    
    # Test GraphQL server
    if curl -f http://localhost:4000/graphql >/dev/null 2>&1; then
      echo "✅ GraphQL server is responding"
    else
      echo "❌ GraphQL server not responding"
      docker compose down
      exit 1
    fi
    
    # Test frontend
    if curl -f http://localhost:3000 >/dev/null 2>&1; then
      echo "✅ Frontend is responding"
    else
      echo "❌ Frontend not responding"
      docker compose down
      exit 1
    fi
    
    # Cleanup
    docker compose down
    echo "✅ Docker integration tests passed"
  fi
else
  echo "ℹ️  Docker not available - skipping Docker integration tests"
fi

# 4. Final security check
echo "🔒 Final security audit..."
npm audit --audit-level=high || {
  echo "❌ High severity security vulnerabilities must be fixed before push!"
  exit 1
}

# Show any moderate/low vulnerabilities as warnings
echo "ℹ️  Checking for lower severity vulnerabilities..."
npm audit --audit-level=moderate || echo "⚠️  Some moderate/low severity vulnerabilities found (non-blocking)"

echo "✅ All pre-push checks passed! Ready to push 🎉"