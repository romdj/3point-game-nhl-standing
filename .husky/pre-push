#!/bin/sh
set -e

echo "ğŸš€ Running pre-push checks..."

# 1. Run build to ensure everything compiles
echo "ğŸ—ï¸  Running full build..."
npm run build

# 2. Run comprehensive tests with coverage
echo "ğŸ§ª Running tests with coverage..."
npm run test:coverage

# 3. Run Docker integration tests (if Docker is available)
if command -v docker >/dev/null 2>&1; then
  echo "ğŸ³ Running Docker integration tests..."
  
  # Test Docker Compose setup
  if [ -f "docker-compose.yml" ]; then
    echo "ğŸ§ª Testing Docker Compose (quick test)..."
    
    # Build images
    docker compose build
    
    # Start services
    docker compose up -d
    
    # Wait for services to be ready
    echo "â³ Waiting for services to start..."
    sleep 15
    
    # Test GraphQL server
    if curl -f http://localhost:4000/graphql >/dev/null 2>&1; then
      echo "âœ… GraphQL server is responding"
    else
      echo "âŒ GraphQL server not responding"
      docker compose down
      exit 1
    fi
    
    # Test frontend
    if curl -f http://localhost:3000 >/dev/null 2>&1; then
      echo "âœ… Frontend is responding"
    else
      echo "âŒ Frontend not responding"
      docker compose down
      exit 1
    fi
    
    # Cleanup
    docker compose down
    echo "âœ… Docker integration tests passed"
  fi
else
  echo "â„¹ï¸  Docker not available - skipping Docker integration tests"
fi

# 4. Final security check
echo "ğŸ”’ Final security audit..."
npm audit --audit-level=high || {
  echo "âŒ High severity security vulnerabilities must be fixed before push!"
  exit 1
}

# Show any moderate/low vulnerabilities as warnings
echo "â„¹ï¸  Checking for lower severity vulnerabilities..."
npm audit --audit-level=moderate || echo "âš ï¸  Some moderate/low severity vulnerabilities found (non-blocking)"

echo "âœ… All pre-push checks passed! Ready to push ğŸ‰"